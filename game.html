<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval Adventures - Game</title>
    <style>
        body {
            font-family: 'Papyrus', sans-serif;
            background-color: #1a1a1a;
            color: #f0e6d2;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        
        /* Character Stats Panel */
        .stats-panel {
            width: 250px;
            background-color: #2c2416;
            border-right: 3px solid #b68511;
            padding: 20px;
            overflow-y: auto;
        }
        
        .character-name {
            font-size: 1.5em;
            color: #b68511;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .character-info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 5px;
        }
        
        .character-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            background-color: #1a1a1a;
            border-radius: 3px;
        }
        
        .stat-label {
            font-weight: bold;
        }
        
        .health-bar {
            width: 100%;
            height: 25px;
            background-color: #4a0e0e;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .health-fill {
            height: 100%;
            background-color: #c41e3a;
            transition: width 0.3s ease;
        }
        
        .health-text {
            text-align: center;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            position: relative;
        }
        
        /* Game Area */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #2a2416;
        }
        
        .game-header {
            background-color: #b68511;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.5em;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%232a2416" width="100" height="100"/><path d="M0 0L100 100M100 0L0 100" stroke="%23b68511" stroke-width="0.5" opacity="0.1"/></svg>');
        }
        
        .message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gm-message {
            background-color: #3d2f1f;
            border-left: 4px solid #b68511;
        }
        
        .player-message {
            background-color: #1a3a1a;
            border-left: 4px solid #4a9d4a;
            margin-left: 40px;
        }
        
        .message-header {
            font-weight: bold;
            color: #b68511;
            margin-bottom: 8px;
        }
        
        .player-message .message-header {
            color: #6fbf73;
        }
        
        /* Input Area */
        .input-container {
            background-color: #2c2416;
            border-top: 2px solid #b68511;
            padding: 20px;
            display: flex;
            gap: 10px;
        }
        
        .input-container input {
            flex: 1;
            padding: 15px;
            font-size: 1em;
            font-family: 'Papyrus', sans-serif;
            background-color: #1a1a1a;
            color: #f0e6d2;
            border: 2px solid #b68511;
            border-radius: 5px;
        }
        
        .input-container input:focus {
            outline: none;
            border-color: #d4a533;
        }
        
        .input-container button {
            padding: 15px 30px;
            font-size: 1em;
            font-family: 'Papyrus', sans-serif;
            background-color: #b68511;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .input-container button:hover {
            background-color: #d4a533;
        }
        
        .input-container button:disabled {
            background-color: #6a5010;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #b68511;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Character Stats Panel -->
    <div class="stats-panel">
        <div class="character-name" id="characterName">Loading...</div>
        
        <div class="character-info">
            <p><strong>Race:</strong> <span id="race"></span></p>
            <p><strong>Class:</strong> <span id="class"></span></p>
            <p><strong>Level:</strong> <span id="level"></span></p>
        </div>
        
        <div class="health-bar">
            <div class="health-fill" id="healthFill" style="width: 100%"></div>
        </div>
        <div class="health-text" id="healthText">100/100 HP</div>
        
        <div style="margin-top: 20px;">
            <div class="stat-item">
                <span class="stat-label">STR:</span>
                <span id="strength">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">DEX:</span>
                <span id="dexterity">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">CON:</span>
                <span id="constitution">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">INT:</span>
                <span id="intelligence">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">WIS:</span>
                <span id="wisdom">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">CHA:</span>
                <span id="charisma">0</span>
            </div>
        </div>
        
        <div class="character-info" style="margin-top: 20px;">
            <p><strong>Weapon:</strong> <span id="weapon"></span></p>
            <p><strong>Armor:</strong> <span id="armor"></span></p>
            <p><strong>Gold:</strong> <span id="money"></span></p>
        </div>
    </div>
    
    <!-- Game Area -->
    <div class="game-container">
        <div class="game-header">Medieval Adventures</div>
        
        <div class="chat-container" id="chatContainer">
            <div class="loading" id="loading">Loading your adventure...</div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="playerInput" 
                placeholder="What do you do?" 
                disabled
            >
            <button id="sendButton" onclick="sendAction()" disabled>Send</button>
        </div>
    </div>

    <script>
        let sessionId = '';
        let characterData = {};
        
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('session');
        
        if (!sessionId) {
            window.location.href = '/';
        }
        
        // Initialize game
        async function initGame() {
            try {
                // The session was created in class.html, so we just need to load the character
                // We can get the character_id from the initial message response
                // For now, we'll make a simple assumption that the session is valid
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('playerInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                document.getElementById('playerInput').focus();
                
                // Load initial message (it's stored when session is created)
                loadSessionData();
            } catch (error) {
                console.error('Error initializing game:', error);
                alert('Failed to start game. Please try again.');
                window.location.href = '/';
            }
        }
        
        async function loadSessionData() {
            // For now, we'll display a welcome message
            // In a full implementation, you'd load the chat history from the session
            addMessage('gm', 'Welcome, adventurer! Your journey begins...');
        }
        
        async function sendAction() {
            const input = document.getElementById('playerInput');
            const action = input.value.trim();
            
            if (!action) return;
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add player message to chat
            addMessage('player', action);
            input.value = '';
            
            // Show loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'responseLoading';
            loadingDiv.textContent = 'The Game Master considers your action...';
            document.getElementById('chatContainer').appendChild(loadingDiv);
            scrollToBottom();
            
            try {
                const response = await fetch('/game_action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        prompt: action
                    })
                });
                
                const data = await response.json();
                
                // Remove loading
                document.getElementById('responseLoading').remove();
                
                if (data.success) {
                    addMessage('gm', data.response);
                } else {
                    addMessage('gm', 'The Game Master seems confused... (Error occurred)');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('responseLoading').remove();
                addMessage('gm', 'The magical connection faltered... (Error occurred)');
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('sendButton').disabled = false;
            input.focus();
        }
        
        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = type === 'gm' ? 'Game Master' : 'You';
            
            const text = document.createElement('div');
            text.textContent = content;
            
            messageDiv.appendChild(header);
            messageDiv.appendChild(text);
            chatContainer.appendChild(messageDiv);
            
            scrollToBottom();
        }
        
        function scrollToBottom() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Allow Enter key to send
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('playerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !this.disabled) {
                    sendAction();
                }
            });
            
            initGame();
        });
        
        // Mock character data for display (you'd load this from the server)
        function updateCharacterDisplay() {
            document.getElementById('characterName').textContent = 'Hero';
            document.getElementById('race').textContent = 'Human';
            document.getElementById('class').textContent = 'Knight';
            document.getElementById('level').textContent = '1';
            document.getElementById('strength').textContent = '19';
            document.getElementById('dexterity').textContent = '14';
            document.getElementById('constitution').textContent = '14';
            document.getElementById('intelligence').textContent = '14';
            document.getElementById('wisdom').textContent = '12';
            document.getElementById('charisma').textContent = '16';
            document.getElementById('weapon').textContent = 'Sword';
            document.getElementById('armor').textContent = 'Chainmail';
            document.getElementById('money').textContent = '50';
        }
        
        updateCharacterDisplay();
    </script>
</body>
</html>
